## Codebase Patterns
- PSR-4 autoloading: `AIRC\` namespace maps to `src/`, PascalCase file names
- Settings stored in `airc_settings` option as array; defaults in `Plugin::get_defaults()`
- Settings fields rendered via dedicated `render_*_field()` methods in `SettingsPage`
- All user-facing strings use `__()` / `esc_html__()` with text domain `ai-ready-content`
- PHPCS WordPress standard has pre-existing errors due to PSR-4 naming; `php -l` is the reliable lint check
- Feature toggles are boolean keys in settings (e.g., `enable_content_negotiation`, `enable_llms_txt`)
- Superglobal sanitization: always `wp_unslash()` first, then `sanitize_text_field()` for text or `esc_url_raw()` for URLs
- Header validation: name `/^[a-zA-Z0-9\-]+$/`, value no `\r`/`\n` — apply to any user-filterable headers
- Content pipeline order in `ContentPreparer::prepare()`: `the_content` → `strip_residual_shortcodes` → `clean_html` → `airc_prepared_html` filter
- AJAX endpoints use `check_ajax_referer()` with post-specific nonce (`airc_preview_{post_id}`) and `current_user_can( 'edit_post', $post_id )` for authorization
- Meta box JS is enqueued via `wp_localize_script()` for config/i18n, enqueued only on `post.php` / `post-new.php` for enabled post types
- Markdown generation can be reused from converter components: `$preparer->prepare()` → `$converter->convert()` → `$frontmatter->generate()`, same pipeline as PostEndpoint
- Gutenberg scripts use `enqueue_block_editor_assets` hook with WP script deps (`wp-plugins`, `wp-edit-post`, etc.); localize via `wp_localize_script()`
- New settings fields: add default in `Plugin::get_defaults()`, register field in `SettingsPage::register_settings()`, create `render_*_field()` method, add sanitization in `sanitize_settings()`
- Image/HTML element processing should happen in `ContentPreparer` (HTML level) before markdown conversion, not after — regex on markdown output is fragile
- WP-CLI commands: guard with `defined( 'WP_CLI' ) && WP_CLI`, register via `WP_CLI::add_command()` with class instance, use phpdoc `## OPTIONS`/`## EXAMPLES` for help text
- Rate limiting AJAX: use `get_transient( 'airc_flush_cooldown' )` check before action, `set_transient( ..., 1, 10 )` after — return HTTP 429 during cooldown
- New endpoints: register on `template_redirect` priority 1, check query var, add rewrite rule + query var in `RewriteHandler`, register in `Plugin::init_components()`
- Cache invalidation: when adding new aggregate endpoints (like sitemap), add `delete_transient()` calls to all existing invalidation hooks in `TransientCache`

## 2026-02-15 - US-001
- Implemented accessibility improvements for admin settings form
- Files changed: `src/Admin/SettingsPage.php`, `templates/admin/settings-page.php`
- Changes:
  - Added `<fieldset>` + `<legend class="screen-reader-text">` around post type checkboxes
  - Created `render_feature_toggles_field()` method grouping all 4 feature toggles in a single fieldset with screen-reader legend (replaced individual `render_checkbox_field` calls)
  - Added `aria-describedby` and `<p class="description">` for both numeric fields (cache TTL already had it partially, post limit was missing it)
  - Added `role="status"`, `aria-live="polite"`, `aria-atomic="true"` to flush cache result span
- **Learnings for future iterations:**
  - The original code had `render_checkbox_field()` as a generic method and 4 separate `add_settings_field` calls — this was consolidated into `render_feature_toggles_field()` for proper fieldset grouping
  - PHPCS global install has compatibility issues with PHP 8.x (trim() null deprecation); use `php -l` for reliable syntax checks
  - Template file is at `templates/admin/settings-page.php` (not in src/Admin/)
---

## 2026-02-15 - US-002
- Implemented input sanitization and output validation for security hardening
- Files changed: `src/Endpoint/PostEndpoint.php`, `src/Router/ContentNegotiator.php`, `src/Router/RewriteHandler.php`
- Changes:
  - PostEndpoint: Added header name validation (alphanumeric + hyphens only) and header value validation (no CR/LF) in the `airc_response_headers` filter loop; invalid headers silently discarded
  - ContentNegotiator: Sanitized `$_SERVER['HTTP_ACCEPT']` via `sanitize_text_field( wp_unslash( ... ) )`
  - RewriteHandler: Sanitized `$_SERVER['REQUEST_URI']` via `esc_url_raw( wp_unslash( ... ) )`
- **Learnings for future iterations:**
  - WordPress security pattern: always `wp_unslash()` superglobals first, then sanitize with appropriate function (`sanitize_text_field` for general text, `esc_url_raw` for URLs)
  - Header injection prevention: validate both name and value separately — name must match `/^[a-zA-Z0-9\-]+$/`, value must not contain `\r` or `\n`
  - The `airc_response_headers` filter is the main attack surface for header injection since it allows external code to add arbitrary headers
---

## 2026-02-15 - US-003
- Implemented residual shortcode stripping from markdown output
- Files changed: `src/Converter/ContentPreparer.php`
- Changes:
  - Added `strip_residual_shortcodes()` private method that removes enclosing `[tag ...]...[/tag]` and self-closing `[tag ...]` patterns using regex
  - Enclosing shortcodes are removed first (greedy match with `.*?` and `/s` flag), then self-closing ones
  - Added `airc_strip_residual_shortcodes` filter (bool, default `true`) to allow disabling the cleanup
  - Stripping runs after `the_content` filters (so legitimate shortcodes are already resolved to HTML) and before `clean_html()`
- **Learnings for future iterations:**
  - Shortcode stripping must happen after `apply_filters( 'the_content', ... )` so registered shortcodes are already resolved to HTML and won't be affected
  - Order matters: remove enclosing `[tag]...[/tag]` first, then self-closing `[tag]`, otherwise the opening tag of an enclosing shortcode gets stripped first leaving the closing tag orphaned
  - The `\b` after `\w+` in the regex prevents matching things like `[123]` or `[a]` which are unlikely to be shortcodes but could be footnote references
---

## 2026-02-15 - US-004
- Implemented accessibility improvements for interactive elements and navigation
- Files changed: `templates/admin/settings-page.php`
- Changes:
  - Added `<span class="screen-reader-text">(opens in a new window)</span>` to the "View llms.txt" link (target="_blank") plus `rel="noopener noreferrer"`
  - Added `aria-busy="true"` to flush cache button during AJAX request, removed on completion/failure
  - Added screen-reader loading text "Flushing cache…" shown in the `aria-live` region during AJAX request
  - Heading hierarchy verified: `<h1>` (page title) → `<h2>` (Cache, Quick Links) is already correct and consistent
- **Learnings for future iterations:**
  - For `target="_blank"` links: always add both `rel="noopener noreferrer"` (security) and a screen-reader-text span with "(opens in a new window)" (accessibility)
  - The `aria-live="polite"` region (`#airc-flush-result`) serves double duty: loading state text and result message — no need for a separate element
  - `aria-busy` goes on the button (not the live region) to indicate the control is processing
---

## 2026-02-15 - US-005
- Implemented markdown preview meta box for the classic editor
- Files changed: `src/Admin/PreviewMetaBox.php` (new), `src/Plugin.php`, `assets/js/metabox.js` (new)
- Changes:
  - Created `PreviewMetaBox` class registered for all enabled post types via `add_meta_box()`
  - Meta box shows: direct `.md` URL link, cache status (Cached/Not cached), Clear Cache button, Load Markdown Preview button with lazy-loaded readonly textarea
  - Three AJAX endpoints: `airc_preview_markdown` (generates and returns markdown), `airc_invalidate_post_cache` (clears single post transient), `airc_post_cache_status` (checks cache state)
  - All AJAX endpoints secured with post-specific nonce and `edit_post` capability check
  - JavaScript (`metabox.js`) handles AJAX interactions with `aria-busy` states and localized i18n strings
  - Registered `PreviewMetaBox` in `Plugin.php` `init_components()`, reusing existing converter component instances
- **Learnings for future iterations:**
  - The converter pipeline (`ContentPreparer` → `MarkdownConverter` → `FrontmatterGenerator`) is already instantiated in `Plugin::init_components()` and can be injected into new classes that need markdown generation
  - For meta box AJAX, use post-specific nonces (`airc_preview_{post_id}`) rather than a global nonce for better security
  - `wp_localize_script()` is used for both AJAX URL and i18n strings — keep all translatable JS strings server-side
  - JS is only enqueued on `post.php` / `post-new.php` hooks for enabled post types to avoid loading on unrelated admin pages
  - US-006 (Gutenberg sidebar) can reuse the same AJAX endpoints created here
---

## 2026-02-15 - US-006
- Implemented Gutenberg sidebar panel for markdown preview and cache status
- Files changed: `src/Admin/PreviewMetaBox.php` (modified), `assets/js/gutenberg-panel.js` (new)
- Changes:
  - Added `enqueue_block_editor_assets` hook in `PreviewMetaBox` constructor to register `enqueue_gutenberg_assets()` method
  - `enqueue_gutenberg_assets()` checks current screen post type against enabled post types, only enqueues for matching types
  - JS file registered with WP script dependencies: `wp-plugins`, `wp-edit-post`, `wp-element`, `wp-components`, `wp-data`
  - Localized `aircGutenberg` config passes AJAX URL, post-specific nonce, enabled post types array, and i18n strings
  - JS uses `wp.plugins.registerPlugin()` with `wp.editPost.PluginDocumentSettingPanel` to render sidebar panel
  - Panel shows: markdown URL (via `ExternalLink` component), cache status (fetched on mount via AJAX), Clear Cache button
  - Reuses same AJAX endpoints from US-005: `airc_post_cache_status`, `airc_invalidate_post_cache`
- **Learnings for future iterations:**
  - `enqueue_block_editor_assets` is the correct hook for Gutenberg-only scripts (not `admin_enqueue_scripts`)
  - Gutenberg panel JS uses vanilla `wp.element.createElement()` — no JSX build step needed for simple panels
  - For Gutenberg, the post type check is done both server-side (screen check in enqueue) and client-side (JS checks `aircGutenberg.enabledPostTypes`)
  - Post ID for nonce comes from `$_GET['post']` (available on `post.php`); for new posts it's 0 and nonce is empty — panel gracefully handles this via `useEffect` guard on `postId`
---

## 2026-02-15 - US-007
- Implemented configurable cache TTL for llms.txt endpoint
- Files changed: `src/Cache/TransientCache.php`
- Changes:
  - Replaced hardcoded `12 * HOUR_IN_SECONDS` TTL in `set_llms_txt()` with the `cache_ttl` value from plugin settings
  - Added TTL=0 guard (matching `set_post_markdown()` pattern) — when cache is disabled, no transient is set
  - No changes needed in `LlmsTxtEndpoint.php` — the existing flow (`get_llms_txt()` returns null → regenerate → `set_llms_txt()`) naturally handles cache-disabled case
- **Learnings for future iterations:**
  - `TransientCache` methods should always follow the same pattern: read settings, check TTL > 0 before setting transient — keeps behavior consistent across all cache operations
  - When cache_ttl=0, `get_*` methods return null (no transient exists), so callers always regenerate — no special handling needed in endpoint classes
---

## 2026-02-15 - US-008
- Implemented custom fields support in YAML frontmatter
- Files changed: `src/Converter/FrontmatterGenerator.php`, `src/Admin/SettingsPage.php`, `src/Plugin.php`
- Changes:
  - Added `frontmatter_meta_keys` default (empty string) in `Plugin::get_defaults()`
  - Added textarea field in settings page for specifying meta keys (one per line) with `aria-describedby` description
  - Added `sanitize_key()` per-line sanitization in `sanitize_settings()` — trims whitespace, filters empty lines, validates meta key characters
  - Added `add_custom_meta_fields()` private method in `FrontmatterGenerator` that reads settings, iterates configured keys, and adds non-empty values to frontmatter
  - Custom fields are inserted before the `airc_frontmatter_fields` filter so the filter can still modify/remove them
- **Learnings for future iterations:**
  - `sanitize_key()` is the appropriate WP function for meta key sanitization — it lowercases and strips non-alphanumeric/dash/underscore chars
  - `get_post_meta()` returns `''` for non-existent keys (when `$single=true`), so checking `'' === $value` handles both non-existent and empty meta cleanly
  - Custom meta fields are added to `$fields` before `apply_filters( 'airc_frontmatter_fields' )` to allow the filter to override or remove them
---

## 2026-02-15 - US-009
- Implemented image handling control for markdown output with three modes: keep, alt text only, remove
- Files changed: `src/Converter/ContentPreparer.php`, `src/Admin/SettingsPage.php`, `src/Plugin.php`
- Changes:
  - Added `image_handling` default (`'keep'`) in `Plugin::get_defaults()`
  - Added `<select>` field in settings with three options: "Keep with alt text", "Alt text only", "Remove"
  - Added `sanitize_settings()` validation against allowed values (`keep`, `alt_only`, `remove`)
  - Added `process_images()` method in `ContentPreparer` that runs after `clean_html()` and before `airc_prepared_html` filter
  - `<figure>` with `<figcaption>` is processed first — caption text preserved in all modes
  - In `alt_only` mode: images replaced with `(alt text)`, figcaption text preserved alongside
  - In `remove` mode: images stripped, figcaption text preserved
  - In `keep` mode: early return, no processing (current behavior unchanged)
- **Learnings for future iterations:**
  - Image processing must happen at the HTML level (in `ContentPreparer`), not after markdown conversion, because the converter turns `<img>` to `![alt](url)` and regex on markdown is fragile
  - Process `<figure>` blocks first before standalone `<img>` tags to avoid double-processing images inside figures
  - `clean_html()` strips CSS classes but keeps structural tags like `<figure>` and `<figcaption>` — this is important for image processing to work correctly after cleanup
  - Select field sanitization pattern: define `$valid_modes` array and use `in_array( ..., true )` for strict comparison
---

## 2026-02-15 - US-010
- Implemented WP-CLI commands for cache management and markdown generation
- Files changed: `src/CLI/Commands.php` (new), `src/Plugin.php`
- Changes:
  - Created `Commands` class with three subcommands: `flush`, `generate`, `status`
  - `wp airc flush`: clears all cache, supports `--post_id=<id>` for single post and `--post_type=<type>` for type-specific flush
  - `wp airc generate`: pre-generates markdown for all enabled posts, supports `--post_type=<type>` filter and `--force` to regenerate cached entries
  - `wp airc status`: shows enabled post types, published post count, cache entries count, total cache size, and cache TTL
  - Registered via `WP_CLI::add_command( 'airc', ... )` in `Plugin::init_components()`, guarded by `defined( 'WP_CLI' ) && WP_CLI`
  - Reuses existing converter pipeline (ContentPreparer → MarkdownConverter → FrontmatterGenerator) and `airc_markdown_output` filter
- **Learnings for future iterations:**
  - WP-CLI commands are registered with `WP_CLI::add_command()` passing a class instance — each public method becomes a subcommand
  - Guard with `defined( 'WP_CLI' ) && WP_CLI` — the constant may not be defined at all in non-CLI contexts
  - Cache size query: use `LENGTH(option_value)` on `_transient_airc_md_*` options; use `COALESCE(..., 0)` to handle empty result
  - `size_format()` and `human_time_diff()` are built-in WP functions useful for CLI output formatting
  - WP-CLI phpdoc `## OPTIONS` and `## EXAMPLES` blocks in method docblocks are parsed by WP-CLI to generate help text
---

## 2026-02-15 - US-011
- Implemented endpoint hardening with rate limiting on cache flush and CSP headers on markdown endpoints
- Files changed: `src/Admin/SettingsPage.php`, `src/Admin/PreviewMetaBox.php`, `src/Endpoint/PostEndpoint.php`, `src/Endpoint/LlmsTxtEndpoint.php`
- Changes:
  - Added 10-second transient cooldown (`airc_flush_cooldown`) to `SettingsPage::ajax_flush_cache()` — returns 429 JSON error during cooldown
  - Added same cooldown to `PreviewMetaBox::ajax_invalidate_post_cache()` — shares the same transient for consistent rate limiting
  - Added `Content-Security-Policy: default-src 'none'` header to `PostEndpoint` default headers array (subject to `airc_response_headers` filter)
  - Added `Content-Security-Policy: default-src 'none'` header to `LlmsTxtEndpoint` (direct `header()` call, matching existing pattern)
- **Learnings for future iterations:**
  - Rate limiting via transient is simple and effective for AJAX endpoints — `set_transient()` with short TTL acts as a cooldown timer
  - Both flush endpoints (settings page global flush and meta box per-post flush) share the same cooldown transient to prevent abuse across either path
  - CSP `default-src 'none'` is the strictest policy — appropriate for non-HTML endpoints (markdown, plain text) since no scripts/styles/images should load
  - PostEndpoint CSP goes in the `$headers` array (filterable via `airc_response_headers`), while LlmsTxtEndpoint uses direct `header()` calls — different patterns because LlmsTxtEndpoint doesn't use the filter system for its headers
---

## 2026-02-15 - US-012
- Implemented JSON sitemap endpoint at `/airc-sitemap.json`
- Files changed: `src/Endpoint/SitemapEndpoint.php` (new), `src/Cache/TransientCache.php`, `src/Router/RewriteHandler.php`, `src/Plugin.php`
- Changes:
  - Created `SitemapEndpoint` class following the same pattern as `LlmsTxtEndpoint` — constructor registers on `template_redirect`, `handle()` checks query var, generates or serves from cache
  - Endpoint returns JSON with: `generated` timestamp, `site` name, `count`, and `posts` array
  - Each post entry includes: `title`, `url` (markdown URL), `post_type`, `date_published`, `date_modified` (both ISO 8601)
  - Respects enabled post types and `llms_txt_post_limit` setting for consistency with llms.txt
  - Added `get_sitemap_json()` / `set_sitemap_json()` cache methods to `TransientCache`, following same TTL pattern
  - Added `airc_sitemap_json` transient invalidation to all cache invalidation hooks (save_post, delete_post, terms change)
  - Added rewrite rule `^airc-sitemap\.json$` and `airc_sitemap_json` query var in `RewriteHandler`
  - Registered `SitemapEndpoint` in `Plugin::init_components()`
  - Response headers: `Content-Type: application/json`, `X-Robots-Tag: noindex`, `X-Content-Type-Options: nosniff`, CSP `default-src 'none'`, `Cache-Control: public, max-age=3600`
- **Learnings for future iterations:**
  - New endpoints follow a consistent pattern: register on `template_redirect` at priority 1, check query var, serve from cache or generate
  - Rewrite rules need three changes: `add_rewrite_rule()` in `RewriteHandler`, query var registration, and `SitemapEndpoint` registration in `Plugin.php`
  - After adding a new rewrite rule, WordPress needs `flush_rewrite_rules()` — this already happens on plugin activation via `Plugin::activate()`
  - `wp_json_encode()` is the WordPress wrapper for `json_encode()` — use it instead of raw `json_encode()` for consistency
  - Sitemap cache invalidation must be added to all the same hooks as llms.txt (save_post, delete_post, terms change) since the sitemap reflects the same post data
---
